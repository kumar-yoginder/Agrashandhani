"""
MalwareBazaar threat intelligence source
API Reference: https://bazaar.abuse.ch/api/
"""
from sources.base import Source
from clients import RateLimitedClient
from config import MB_API_URL, MB_API_KEY


bazaar_client = RateLimitedClient(max_retries=3)


class MalwareBazaarSource(Source):
    """MalwareBazaar source handler - queries malware samples and hashes"""
    
    def __init__(self):
        super().__init__("malwarebazaar")
        self.api_url = MB_API_URL
        self.api_key = MB_API_KEY
    
    def query(self, ioc_type: str, value: str) -> dict:
        """
        Query MalwareBazaar API
        Supported IOC types:
            - hash_md5: Query by MD5 hash
            - hash_sha1: Query by SHA1 hash
            - hash_sha256: Query by SHA256 hash
            - imphash: Query by import hash
            - tlsh: Query by TLSH hash
            - telfhash: Query by ELF hash
            - gimphash: Query by Go import hash
        """
        if not self.api_key:
            return {"error": "MB_API_KEY not configured. Get it from https://auth.abuse.ch/"}
        
        # Determine query type based on IOC type
        query_info = self._get_query_type(ioc_type, value)
        if not query_info or query_info[0] is None:
            return {"error": f"MalwareBazaar does not support {ioc_type}"}
        
        query_type, param_name = query_info
        
        # Build request
        headers = {"Auth-Key": self.api_key}
        data = {"query": query_type, param_name: value}
        
        try:
            response = bazaar_client.request(
                "POST",
                self.api_url,
                data=data,
                headers=headers,
                timeout=20
            )
            
            if isinstance(response, dict):
                # Handle API response
                if response.get("query_status") == "ok":
                    return self._parse_response(response)
                elif response.get("query_status") in ["hash_not_found", "no_results"]:
                    return {"query_status": "not_found", "data": []}
                else:
                    return {"error": response.get("query_status", "Unknown error")}
            
            return response
        except Exception as e:
            return {"error": str(e)}
    
    def _get_query_type(self, ioc_type: str, value: str) -> str:
        """Map IOC type to MalwareBazaar query type"""
        query_map = {
            "hash_md5": ("get_info", "hash"),
            "hash_sha1": ("get_info", "hash"),
            "hash_sha256": ("get_info", "hash"),
            "imphash": ("get_imphash", "imphash"),
            "tlsh": ("get_tlsh", "tlsh"),
            "telfhash": ("get_telfhash", "telfhash"),
            "gimphash": ("get_gimphash", "gimphash"),
        }
        result = query_map.get(ioc_type)
        return result if result else (None, None)
    
    def _parse_response(self, response: dict) -> dict:
        """Parse MalwareBazaar API response"""
        result = {
            "query_status": "ok",
            "source": "malwarebazaar",
            "data": []
        }
        
        # Handle single result (get_info query)
        if "sha256_hash" in response:
            result["data"] = [self._format_sample(response)]
        
        # Handle multiple results (tag, signature, filetype queries)
        elif "data" in response and isinstance(response["data"], list):
            result["data"] = [self._format_sample(sample) for sample in response["data"]]
        
        return result
    
    def _format_sample(self, sample: dict) -> dict:
        """Format a malware sample entry"""
        return {
            "sha256": sample.get("sha256_hash"),
            "sha1": sample.get("sha1_hash"),
            "md5": sample.get("md5_hash"),
            "sha3_384": sample.get("sha3_384_hash"),
            "filename": sample.get("file_name"),
            "file_size": sample.get("file_size"),
            "file_type": sample.get("file_type"),
            "file_format": sample.get("file_format"),
            "file_architecture": sample.get("file_arch"),
            "mime_type": sample.get("file_type_mime"),
            "malware_family": sample.get("signature"),
            "first_seen": sample.get("first_seen"),
            "last_seen": sample.get("last_seen"),
            "reporter": sample.get("reporter"),
            "anonymous": sample.get("anonymous"),
            "tags": sample.get("tags", []),
            "imphash": sample.get("imphash"),
            "tlsh": sample.get("tlsh"),
            "telfhash": sample.get("telfhash"),
            "gimphash": sample.get("gimphash"),
            "ssdeep": sample.get("ssdeep"),
            "magika": sample.get("magika"),
            "dhash_icon": sample.get("dhash_icon"),
            "trid": sample.get("trid"),
            "yara_rules": sample.get("yara_rules", []),
            "clamav_detections": sample.get("intelligence", {}).get("clamav"),
            "downloads": sample.get("intelligence", {}).get("downloads"),
            "uploads": sample.get("intelligence", {}).get("uploads"),
            "code_signing": sample.get("code_sign"),
            "delivery_method": sample.get("delivery_method"),
            "comments": sample.get("comments", []),
        }
